<!-- React dashboard served by Flask for the Unvanquished Pi-5 stack -->
{%- raw -%}
<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Unvanquished Pi-5 Dashboard</title>

<link rel="stylesheet"
 href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap"/>
<link rel="stylesheet"
 href="https://fonts.googleapis.com/icon?family=Material+Icons"/>

<script crossorigin="anonymous"
 integrity="sha384-DGyLxAyjq0f9SPpVevD6IgztCFlnMF6oW/XQGmfe+IsZ8TqEiDrcHkMLKI6fiB/Z"
 src="https://unpkg.com/react@18.3.1/umd/react.production.min.js"></script>
<script crossorigin="anonymous"
 integrity="sha384-gTGxhz21lVGYNMcdJOyq01Edg0jhn/c22nsx0kyqP0TxaV5WVdsSH1fSDUf5YJj1"
 src="https://unpkg.com/react-dom@18.3.1/umd/react-dom.production.min.js"></script>
<script crossorigin="anonymous"
 integrity="sha384-gfoIoghgrQ+acOP1IAci7PIH0wjwxDVkjgSczIHAcAGEWKu6Ztq1HaNa41oW95ya"
 src="https://unpkg.com/@babel/standalone@7.26.0/babel.min.js"></script>

<script crossorigin="anonymous"
 integrity="sha384-C1jZRQpcgcAFclz/eCOntp9Rs1moYZ1axTf9rL7aS3DQMSW3XESRolQKVUey9T3C"
 src="https://unpkg.com/@mui/material@5.15.14/umd/material-ui.production.min.js"></script>

<script>
window.API_STATUS_URL = "/api/status";
window.API_LOCALXPOSE_URL = "/api/localxpose_status";
</script>

</head>
<body style="margin:0;background:#000;">
<div id="root"></div>

<script type="text/babel">

const {
  Box, Typography, Chip, Card, CardHeader, CardContent,
  Button, Stack, Table, TableHead, TableRow, TableCell,
  TableBody, ThemeProvider, createTheme, CssBaseline, Container
} = MaterialUI;

function useServerData() {
  const [status, setStatus] = React.useState({loading:true, error:"", data:null});
  const [lx, setLx] = React.useState({loading:true, error:"", data:null});

  React.useEffect(() => {
    let dead = false;

    async function tick() {
      try {
        const r = await fetch(window.API_STATUS_URL);
        const j = await r.json();
        if (!dead) setStatus({loading:false,error:"",data:j});
      } catch(e) {
        if (!dead) setStatus(p => ({loading:false,error:String(e),data:p.data}));
      }

      try {
        const r = await fetch(window.API_LOCALXPOSE_URL);
        const j = await r.json();
        if (!dead) setLx({loading:false,error:"",data:j});
      } catch(e) {
        if (!dead) setLx(p => ({loading:false,error:String(e),data:p.data}));
      }
    }

    tick();
    const id = setInterval(tick, 5000);
    return () => { dead = true; clearInterval(id); };
  }, []);

  return {status, lx};
}

function StatusChip({label, online}) {
  return (
    <Chip
      label={label + ": " + (online ? "Online" : "Offline")}
      color={online ? "success" : "error"}
      size="small"
      variant={online ? "filled" : "outlined"}
    />
  );
}

function App() {
  const {status, lx} = useServerData();

  const serverOnline = !!(status.data && status.data.online);
  const info = (status.data && status.data.info) || {};
  const players = (status.data && status.data.players) || [];

  const lxData = lx.data || {};
  const lxOnline = !!lxData.online;
  const lxUrl = lxData.public_url || "N/A";

  const theme = createTheme({
    palette: {
      mode: "dark",
      primary: { main: "#4caf50" }
    }
  });

  const copyLocalxpose = () => {
    if (lxOnline && lxUrl !== "N/A")
      navigator.clipboard.writeText(lxUrl);
  };

  return (
    <ThemeProvider theme={theme}>
      <CssBaseline/>
      <Box sx={{py:4, bgcolor:"#000", minHeight:"100vh"}}>
        <Container maxWidth="md">

          <Typography variant="h4" gutterBottom>
            Unvanquished Pi-5 Server Dashboard
          </Typography>

          <Stack direction="row" spacing={1} sx={{mb:2}}>
            <Chip label="React" variant="outlined"/>
            <Chip label="Material UI" variant="outlined"/>
            <Chip label="Flask" variant="outlined"/>
            <Chip label="Docker" variant="outlined"/>
          </Stack>

          <Stack spacing={2}>

            <Card>
              <CardHeader
                title="Game Server"
                action={<StatusChip label="Server" online={serverOnline}/>}
              />
              <CardContent>
                {status.loading ? (
                  <Typography>Loadingâ€¦</Typography>
                ) : (
                <>
                  <Box sx={{
                    display:"grid",
                    gridTemplateColumns:"repeat(auto-fit, minmax(140px,1fr))",
                    gap:1, mb:1
                  }}>
                    <Box>
                      <Typography variant="caption">Hostname</Typography>
                      <Typography>{info.sv_hostname || "N/A"}</Typography>
                    </Box>
                    <Box>
                      <Typography variant="caption">Map</Typography>
                      <Typography>{info.mapname || "N/A"}</Typography>
                    </Box>
                    <Box>
                      <Typography variant="caption">Game</Typography>
                      <Typography>{info.gamename || "N/A"}</Typography>
                    </Box>
                    <Box>
                      <Typography variant="caption">Players</Typography>
                      <Typography>{players.length}</Typography>
                    </Box>
                  </Box>

                  {players.length > 0 && (
                    <Table size="small">
                      <TableHead>
                        <TableRow>
                          <TableCell>#</TableCell>
                          <TableCell>Name</TableCell>
                          <TableCell>Score</TableCell>
                          <TableCell>Ping</TableCell>
                        </TableRow>
                      </TableHead>
                      <TableBody>
                        {players.map((p,i) => (
                          <TableRow key={i}>
                            <TableCell>{i+1}</TableCell>
                            <TableCell>{p.name}</TableCell>
                            <TableCell>{p.score}</TableCell>
                            <TableCell>{p.ping}</TableCell>
                          </TableRow>
                        ))}
                      </TableBody>
                    </Table>
                  )}
                </>
                )}
              </CardContent>
            </Card>

            <Card>
              <CardHeader
                title="LocalXpose Tunnel"
                action={<StatusChip label="LocalXpose" online={lxOnline}/>}
              />
              <CardContent>
                <Typography variant="caption">Public UDP URL</Typography>
                <Typography sx={{wordBreak:"break-all", mb:1}}>
                  {lxUrl}
                </Typography>

                <Stack direction="row" spacing={1}>
                  <Button
                    variant="contained"
                    color="primary"
                    size="small"
                    onClick={copyLocalxpose}
                    disabled={!lxOnline}
                  >
                    Copy LocalXpose Address
                  </Button>
                </Stack>

                {lx.error && (
                  <Typography variant="caption" color="warning.main">
                    Error: {lx.error}
                  </Typography>
                )}
              </CardContent>
            </Card>

          </Stack>
        </Container>
      </Box>
    </ThemeProvider>
  );
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(<App />);
</script>

</body>
</html>
{%- endraw -%}
